<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SportsBridge â€¢ Password Login</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container" style="max-width:480px;">
  <div class="card shadow-sm mt-5">
    <div class="card-body">
      <h4 class="mb-3">Login with Password</h4>
      <div id="alert" class="alert d-none" role="alert"></div>
      <div class="mb-3">
        <label class="form-label">Phone (E.164, e.g. +919876543210)</label>
        <input id="phone" type="text" class="form-control" placeholder="+91XXXXXXXXXX" />
      </div>
      <div class="mb-3">
        <label class="form-label">Password</label>
        <input id="password" type="password" class="form-control" />
      </div>
      <div class="d-grid gap-2">
        <button id="loginBtn" class="btn btn-primary">Login</button>
        <a href="/otp-login.html" class="btn btn-outline-secondary">Use OTP Login/Signup</a>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const alertBox = document.getElementById('alert');
  const loginBtn = document.getElementById('loginBtn');
  function show(msg, type){ alertBox.className = 'alert alert-' + (type||'info'); alertBox.textContent = msg; alertBox.classList.remove('d-none'); }
  async function call(url, body){
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    let j = {};
    try { j = await res.json(); } catch(_) {}
    if (!res.ok) throw new Error((j && j.error) || res.statusText);
    return j;
  }
  function normalizePhone(p){
    const raw = (p||'').trim();
    if (/^\d{10}$/.test(raw)) return '+91' + raw; // default to +91 for plain 10 digits
    return raw;
  }
  async function sessionAttach(){
    const token = localStorage.getItem('sb_token');
    if (!token) return;
    try {
      await fetch('/api/auth/session-attach', { method:'POST', headers:{ 'Authorization': 'Bearer ' + token }});
    } catch(_) {}
  }
  loginBtn.onclick = async()=>{
    const phoneRaw = document.getElementById('phone').value;
    const password = document.getElementById('password').value;
    const phone = normalizePhone(phoneRaw);
    if (!password || password.length < 1) { show('Please enter your password', 'warning'); return; }
    loginBtn.disabled = true; loginBtn.textContent = 'Logging in...';
    try{
      const j = await call('/api/auth/password-login', { phone, password });
      localStorage.setItem('sb_token', j.token);
      await sessionAttach();
      show('Logged in successfully!', 'success');
      setTimeout(()=> location.href = '/dashboard', 600);
    }catch(e){ show(e.message, 'danger'); }
    finally{ loginBtn.disabled = false; loginBtn.textContent = 'Login'; }
  };
})();
</script>
</body>
</html>
