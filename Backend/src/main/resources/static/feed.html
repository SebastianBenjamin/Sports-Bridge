<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SportsBridge • Explore Feed</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <style>
    .skeleton { background: linear-gradient(90deg, #eee 25%, #f5f5f5 37%, #eee 63%); background-size: 400% 100%; animation: shine 1.2s ease-in-out infinite; }
    @keyframes shine { 0% { background-position: 100% 0 } 100% { background-position: -100% 0 } }
    .like-btn { border: 1px solid #dc3545; color: #dc3545; }
    .like-btn.liked { background: #dc3545; color: white; }
    .img-grid img { max-width: 200px; border-radius: 6px; }
  </style>
</head>
<body class="bg-light">
<div class="container py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0">Explore Feed</h3>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-success" href="/create-post.html">Create Post</a>
      <a id="loginBtn" class="btn btn-primary d-none" href="/otp-login.html">Login</a>
      <button id="logoutBtn" class="btn btn-outline-secondary d-none">Logout</button>
    </div>
  </div>
  <div id="app"></div>
</div>

<script>
(function toggleAuthButtons(){
  const token = localStorage.getItem('sb_token');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  if (token) {
    logoutBtn.classList.remove('d-none');
    loginBtn.classList.add('d-none');
    logoutBtn.onclick = function(){ localStorage.removeItem('sb_token'); location.reload(); };
  } else {
    loginBtn.classList.remove('d-none');
    logoutBtn.classList.add('d-none');
  }
})();
</script>

<script type="text/babel">
const api = async (url, opts={}) => {
  const token = localStorage.getItem('sb_token');
  const headers = opts.headers || {};
  if (token) headers['Authorization'] = 'Bearer ' + token;
  opts.headers = headers;
  const res = await fetch(url, opts);
  let data = null;
  try { data = await res.json(); } catch(_) { data = {}; }
  if (!res.ok) {
    if (res.status === 401) throw new Error('Unauthorized: please login to continue');
    throw new Error((data && data.error) || res.statusText);
  }
  return data;
};

const Img = ({src, alt, className, style}) => {
  const [okSrc, setOkSrc] = React.useState(src);
  return <img src={okSrc} alt={alt||''} className={className} style={style} onError={()=>setOkSrc('https://via.placeholder.com/200x150?text=Image')} />
};

function SkeletonCard(){
  return (
    <div className="card mb-3">
      <div className="card-body">
        <div className="d-flex align-items-center mb-2">
          <div className="rounded-circle me-2 skeleton" style={{width:40, height:40}}></div>
          <div>
            <div className="skeleton" style={{width:160, height:14, borderRadius:4}}></div>
            <div className="skeleton mt-1" style={{width:120, height:10, borderRadius:4}}></div>
          </div>
        </div>
        <div className="skeleton" style={{width:'80%', height:14, borderRadius:4}}></div>
        <div className="skeleton mt-2" style={{width:'95%', height:160, borderRadius:8}}></div>
      </div>
    </div>
  );
}

function App(){
  const [page, setPage] = React.useState(0);
  const [items, setItems] = React.useState([]);
  const [error, setError] = React.useState('');
  const [loading, setLoading] = React.useState(true);
  const [loadingMore, setLoadingMore] = React.useState(false);
  const [hasMore, setHasMore] = React.useState(true);
  const pageSize = 10;

  const loadFeed = async(p=0, append=false)=>{
    try{
      if (!append) { setItems([]); setLoading(true); setHasMore(true); }
      else setLoadingMore(true);
      setError('');
      const data = await api(`/api/posts/feed?page=${p}&size=${pageSize}`);
      const arr = Array.isArray(data) ? data : (data.items || []);
      setItems(prev => append ? prev.concat(arr) : arr);
      setPage(p);
      setHasMore(arr.length === pageSize);
    }catch(e){
      setError(e.message);
    } finally { setLoading(false); setLoadingMore(false); }
  };

  React.useEffect(()=>{ loadFeed(0); },[]);

  const toggleLike = async(id)=>{
    try{
      setError('');
      // optimistic update
      setItems(prev => prev.map(x => x.id===id ? ({...x, liked_by_current_user: !x.liked_by_current_user, like_count: (x.like_count || 0) + (x.liked_by_current_user ? -1 : 1)}) : x));
      const resp = await api(`/api/posts/${id}/like`, {method:'POST'});
      setItems(prev => prev.map(x => x.id===id ? ({...x, liked_by_current_user: resp.liked, like_count: resp.likeCount}) : x));
    }catch(e){ setError(e.message); }
  };

  const retry = ()=> loadFeed(page, false);

  return (
    <div>
      {error && (
        <div className="alert alert-danger d-flex align-items-center justify-content-between">
          <div>
            {error}
            {error.includes('Unauthorized') && (
              <>
                {' '}<a href="/otp-login.html" className="alert-link">Login</a> to like and post.
              </>
            )}
          </div>
          <button className="btn btn-sm btn-outline-light" onClick={retry}>Retry</button>
        </div>
      )}
      {loading && (<>
        <SkeletonCard/><SkeletonCard/>
      </>)}
      {!loading && items.length === 0 && (
        <div className="text-center text-muted py-5">No posts yet. Be the first to share!</div>
      )}
      {!loading && items.map(p=> (
        <div key={p.id} className="card mb-3">
          <div className="card-body">
            <div className="d-flex align-items-center mb-2">
              <Img src={(p.user && p.user.profilePicUrl) || 'https://via.placeholder.com/40'} className="rounded-circle me-2" style={{width:40, height:40}}/>
              <div>
                <div><strong>{p.user?.name || 'Unknown'}</strong></div>
                <small className="text-muted">{p.created_at ? new Date(p.created_at).toLocaleString() : ''}</small>
              </div>
            </div>
            {p.caption && <p className="mb-2">{p.caption}</p>}
            {(p.images||[]).length>0 && (
              <div className="d-flex flex-wrap gap-2 img-grid">
                {p.images.map((url,i)=> <Img key={i} src={url} />) }
              </div>
            )}
            <div className="mt-2 d-flex align-items-center gap-3">
              <button className={`btn btn-sm like-btn ${p.liked_by_current_user ? 'liked' : ''}`} onClick={()=>toggleLike(p.id)}>
                {p.liked_by_current_user ? '❤ Liked' : '♡ Like'}
              </button>
              <span>{p.like_count || 0} likes</span>
            </div>
          </div>
        </div>
      ))}

      {!loading && hasMore && (
        <div className="text-center">
          <button className="btn btn-outline-primary" disabled={loadingMore} onClick={()=>loadFeed(page+1, true)}>
            {loadingMore ? 'Loading...' : 'Load more'}
          </button>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
</script>
</body>
</html>
