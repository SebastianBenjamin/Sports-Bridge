<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SportsBridge Feed (Dev Mock)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <style>
    .skeleton { background: linear-gradient(90deg, #eee 25%, #f5f5f5 37%, #eee 63%); background-size: 400% 100%; animation: shine 1.2s ease-in-out infinite; }
    @keyframes shine { 0% { background-position: 100% 0 } 100% { background-position: -100% 0 } }
  </style>
</head>
<body class="bg-light">
<div class="container py-3">
  <h3>SportsBridge Unified Feed (Dev)</h3>
  <div id="app"></div>
</div>

<script type="text/babel">
const api = async (url, opts={}) => {
  const token = localStorage.getItem('sb_token');
  const headers = opts.headers || {};
  if (token) headers['Authorization'] = 'Bearer ' + token;
  opts.headers = headers;
  const res = await fetch(url, opts);
  const data = await res.json().catch(()=>({}));
  if (!res.ok) throw new Error(data.error || res.statusText);
  return data;
};

const Img = ({src, alt, className, style}) => {
  const [okSrc, setOkSrc] = React.useState(src);
  return <img src={okSrc} alt={alt||''} className={className} style={style} onError={()=>setOkSrc('https://via.placeholder.com/200x150?text=Image')} />
};

function SkeletonCard(){
  return (
    <div className="card mb-3">
      <div className="card-body">
        <div className="d-flex align-items-center mb-2">
          <div className="rounded-circle me-2 skeleton" style={{width:40, height:40}}></div>
          <div>
            <div className="skeleton" style={{width:160, height:14, borderRadius:4}}></div>
            <div className="skeleton mt-1" style={{width:120, height:10, borderRadius:4}}></div>
          </div>
        </div>
        <div className="skeleton" style={{width:'80%', height:14, borderRadius:4}}></div>
        <div className="skeleton mt-2" style={{width:'95%', height:160, borderRadius:8}}></div>
      </div>
    </div>
  );
}

function App(){
  const [page, setPage] = React.useState(0);
  const [items, setItems] = React.useState([]);
  const [error, setError] = React.useState('');
  const [loading, setLoading] = React.useState(true);
  const [signup, setSignup] = React.useState({fullName:'', role:'ATHLETE', phone:'', aadhaar:'', email:''});
  const [login, setLogin] = React.useState({phone:'', aadhaar:''});
  const [verify, setVerify] = React.useState({phone:'', otp:''});
  const [caption, setCaption] = React.useState('');
  const [images, setImages] = React.useState([]);

  const loadFeed = async(p=0)=>{
    try{
      setError(''); setLoading(true);
      const data = await api(`/api/posts/feed?page=${p}&size=10`);
      setItems(data.items || []);
      setPage(data.page || 0);
    }catch(e){
      // Fallback to mock data for demo stability
      try{
        const res = await fetch('/mock_feed.json');
        const j = await res.json();
        setItems(j.items||[]);
      }catch{
        setError(e.message);
      }
    } finally { setLoading(false); }
  };

  React.useEffect(()=>{ loadFeed(0); },[]);

  const peekOtpDev = async (phone) => {
    try{
      const resp = await fetch(`/api/auth/dev/peek-otp?phone=${encodeURIComponent(phone)}`);
      const j = await resp.json().catch(()=>({}));
      if (j && j.otp) alert('Dev OTP: ' + j.otp);
    }catch{ /* ignore in prod */ }
  };

  const startSignup = async()=>{
    try{ setError('');
      await api('/api/auth/signup', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(signup)});
      alert('OTP sent to phone for signup');
      setVerify(v=>({...v, phone: signup.phone}));
      peekOtpDev(signup.phone);
    }catch(e){ setError(e.message); }
  };
  const startLogin = async()=>{
    try{ setError('');
      await api('/api/auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(login)});
      alert('OTP sent to phone for login');
      setVerify(v=>({...v, phone: login.phone}));
      peekOtpDev(login.phone);
    }catch(e){ setError(e.message); }
  };
  const doVerify = async()=>{
    try{ setError('');
      const data = await api('/api/auth/verify', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(verify)});
      if (data.token){ localStorage.setItem('sb_token', data.token); alert('Logged in'); }
    }catch(e){ setError(e.message); }
  };

  const createPost = async()=>{
    try{ setError('');
      const fd = new FormData();
      fd.append('caption', caption);
      for (const f of images) fd.append('images', f);
      await api('/api/posts', {method:'POST', body: fd});
      setCaption(''); setImages([]);
      await loadFeed(0);
    }catch(e){ setError(e.message); }
  };
  const toggleLike = async(id)=>{
    try{ setError('');
      await api(`/api/posts/${id}/toggle-like`, {method:'POST'});
      await loadFeed(page);
    }catch(e){ setError(e.message); }
  };

  return (
    <div className="row g-3">
      <div className="col-lg-4">
        <div className="card"><div className="card-body">
          <h5>Auth (Dev)</h5>
          <div className="mb-2">Token: {localStorage.getItem('sb_token')? 'Present' : 'None'}</div>
          <button className="btn btn-sm btn-secondary mb-2" onClick={()=>{localStorage.removeItem('sb_token'); alert('Logged out');}}>Logout</button>
          <hr/>
          <h6>Signup</h6>
          <input className="form-control mb-1" placeholder="Full Name" value={signup.fullName} onChange={e=>setSignup({...signup, fullName:e.target.value})}/>
          <select className="form-select mb-1" value={signup.role} onChange={e=>setSignup({...signup, role:e.target.value})}>
            <option>ATHLETE</option><option>COACH</option><option>SPONSOR</option><option>USER</option>
          </select>
          <input className="form-control mb-1" placeholder="Phone +E164" value={signup.phone} onChange={e=>setSignup({...signup, phone:e.target.value})}/>
          <input className="form-control mb-1" placeholder="Aadhaar (12 digits)" value={signup.aadhaar} onChange={e=>setSignup({...signup, aadhaar:e.target.value})}/>
          <input className="form-control mb-2" placeholder="Email (optional)" value={signup.email} onChange={e=>setSignup({...signup, email:e.target.value})}/>
          <button className="btn btn-primary w-100" onClick={startSignup}>Start Signup</button>
          <hr/>
          <h6>Login</h6>
          <input className="form-control mb-1" placeholder="Phone +E164" value={login.phone} onChange={e=>setLogin({...login, phone:e.target.value})}/>
          <input className="form-control mb-2" placeholder="Aadhaar (12 digits)" value={login.aadhaar} onChange={e=>setLogin({...login, aadhaar:e.target.value})}/>
          <button className="btn btn-outline-primary w-100" onClick={startLogin}>Start Login</button>
          <hr/>
          <h6>Verify OTP</h6>
          <input className="form-control mb-1" placeholder="Phone" value={verify.phone} onChange={e=>setVerify({...verify, phone:e.target.value})}/>
          <input className="form-control mb-2" placeholder="OTP" value={verify.otp} onChange={e=>setVerify({...verify, otp:e.target.value})}/>
          <button className="btn btn-success w-100" onClick={doVerify}>Verify</button>
        </div></div>
      </div>
      <div className="col-lg-8">
        <div className="card mb-3"><div className="card-body">
          <h5>Create Post</h5>
          <input className="form-control mb-2" placeholder="Caption" value={caption} onChange={e=>setCaption(e.target.value)}/>
          <input className="form-control mb-2" type="file" multiple onChange={e=>setImages(Array.from(e.target.files))}/>
          <button className="btn btn-primary" onClick={createPost}>Post</button>
        </div></div>
        {error && <div className="alert alert-danger">{error}</div>}
        {loading && (<>
          <SkeletonCard/><SkeletonCard/>
        </>)}
        {!loading && items.map(p=> (
          <div key={p.id} className="card mb-3">
            <div className="card-body">
              <div className="d-flex align-items-center mb-2">
                <Img src={(p.author && p.author.profilePicUrl) || 'https://via.placeholder.com/40'} className="rounded-circle me-2" style={{width:40, height:40}}/>
                <div>
                  <div><strong>{p.author?.fullName || 'Unknown'}</strong> {p.author?.role && <span className="badge bg-secondary ms-2">{p.author.role}</span>}</div>
                  <small className="text-muted">{p.createdAt ? new Date(p.createdAt).toLocaleString() : ''}</small>
                </div>
              </div>
              <p>{p.caption}</p>
              {(p.images||[]).length>0 && (
                <div className="d-flex flex-wrap gap-2">
                  {Array.from(p.images).map((url,i)=> <Img key={i} src={url} style={{maxWidth: '200px', borderRadius: '6px'}}/>) }
                </div>
              )}
              <div className="mt-2 d-flex align-items-center gap-3">
                <button className="btn btn-sm btn-outline-primary" onClick={()=>toggleLike(p.id)}>Like</button>
                <span>{p.likeCount} likes</span>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
</script>
</body>
</html>
